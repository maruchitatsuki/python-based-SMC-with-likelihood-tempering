Traceback (most recent call last):
  File "D:\anaconda3\envs\assim\lib\site-packages\jupyter_cache\executors\utils.py", line 58, in single_nb_execution
    executenb(
  File "D:\anaconda3\envs\assim\lib\site-packages\nbclient\client.py", line 1305, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
  File "D:\anaconda3\envs\assim\lib\site-packages\jupyter_core\utils\__init__.py", line 173, in wrapped
    return loop.run_until_complete(inner)
  File "D:\anaconda3\envs\assim\lib\asyncio\base_events.py", line 649, in run_until_complete
    return future.result()
  File "D:\anaconda3\envs\assim\lib\site-packages\nbclient\client.py", line 705, in async_execute
    await self.async_execute_cell(
  File "D:\anaconda3\envs\assim\lib\site-packages\nbclient\client.py", line 1058, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "D:\anaconda3\envs\assim\lib\site-packages\nbclient\client.py", line 914, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
# --- ODEã¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆté…åˆ—ã‚’æŒ‡å®šã™ã‚‹ç‰ˆï¼‰ ---
def mm_ode(t, S, Vmax, Km):
    return - Vmax * S / (Km + S)

def simulate_mm_on_grid(Vmax, Km, S0, t_array):
    """
    è¦³æ¸¬æ™‚åˆ» t_array ã«åˆã‚ã›ã¦ãƒŸã‚«ã‚¨ãƒªã‚¹ãƒ¡ãƒ³ãƒ†ãƒ³é€²è¡Œæ›²ç·šã‚’è§£ãã€‚
    æˆ»ã‚Šå€¤: P_model(t_array)
    """
    t_span = (t_array[0], t_array[-1])

    sol = solve_ivp(
        fun=lambda t, S: mm_ode(t, S, Vmax, Km),
        t_span=t_span,
        y0=[S0],
        t_eval=t_array,
        method="RK45",
    )
    S_model = sol.y[0]
    P_model = S0 - S_model
    return P_model

@ray.remote
def log_likelihood_mm_multi(params):
    """
    è¤‡æ•°ã® S0 æ¡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸå¯¾æ•°å°¤åº¦é–¢æ•°ã€‚
    
    params  : [Vmax, Km, sigma]
    dataset : load_all_mm_data() ã§èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ
    """
        
    Vmax, Km, sigma = params

    # Ïƒã‚’æ¨å®šã—ãªã„å ´åˆï¼Œsigmaã¯sigma_trueã«å›ºå®šã•ã‚Œã‚‹
    if est_sigma:
        sigma = params[-1]
    else:
        sigma = sigma_true


    if sigma <= 0:
        return -np.inf

    logL_total = 0.0
    P_model_list = []

    for i in range(n_ex):
        t     = dataset[i]["t"]
        P_obs = dataset[i]["P_obs"]
        S0    = dataset[i]["S0"]

        # ãƒ¢ãƒ‡ãƒ«äºˆæ¸¬
        P_model = simulate_mm_on_grid(Vmax, Km, S0, t)

        # æ®‹å·®
        residual = P_obs - P_model

        logL_i = -0.5 * datapoint * np.log(2*np.pi*sigma**2) \
                 - np.sum(residual**2) / (2*sigma**2)

        logL_total += logL_i
        P_model_list.append(P_model)


    return logL_total, P_model_list

def sim_particle(particle):
    print('sim_particle')

    # ä¸¦åˆ—åŒ–è¨ˆç®—ã‚’å®Ÿè¡Œã™ã‚‹
    results = [log_likelihood_mm_multi.remote(particle[i,:]) for i in range(n_particle)]
    # print(results)

    # ä¸¦åˆ—è¨ˆç®—ã®çµæœã‚’å–å¾—ã™ã‚‹
    llk_Cl = ray.get(results)

    # å–å¾—ã—ãŸçµæœã‚’ä½¿ãˆã‚‹å½¢ã«æˆå‹ã™ã‚‹
    llk, C_l_ = zip(*llk_Cl)

    return llk,C_l_

------------------


[1;31m---------------------------------------------------------------------------[0m
[1;31mNameError[0m                                 Traceback (most recent call last)
Cell [1;32mIn[1], line 23[0m
[0;32m     20[0m     P_model [38;5;241m=[39m S0 [38;5;241m-[39m S_model
[0;32m     21[0m     [38;5;28;01mreturn[39;00m P_model
[1;32m---> 23[0m [38;5;129m@ray[39m[38;5;241m.[39mremote
[0;32m     24[0m [38;5;28;01mdef[39;00m [38;5;21mlog_likelihood_mm_multi[39m(params):
[0;32m     25[0m [38;5;250m    [39m[38;5;124;03m"""[39;00m
[0;32m     26[0m [38;5;124;03m    è¤‡æ•°ã® S0 æ¡ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸå¯¾æ•°å°¤åº¦é–¢æ•°ã€‚[39;00m
[0;32m     27[0m [38;5;124;03m    [39;00m
[0;32m     28[0m [38;5;124;03m    params  : [Vmax, Km, sigma][39;00m
[0;32m     29[0m [38;5;124;03m    dataset : load_all_mm_data() ã§èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ[39;00m
[0;32m     30[0m [38;5;124;03m    """[39;00m
[0;32m     32[0m     Vmax, Km, sigma [38;5;241m=[39m params

[1;31mNameError[0m: name 'ray' is not defined

