---
jupytext:
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.11.5
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---

# Sequential Monte Carlo (SMC) の全体像

このページの目的は、コードを読む前に  
<b>「SMCが頭の中でどう動いているのか」</b>というモデルを作ることです。

数式の厳密な導出や理論的証明は扱わず、  
粒子がどのように動き、なぜその処理が必要なのかを  
**直感的に理解できること**を目標とします。

---

## このページで伝えたいこと

Sequential Monte Carlo（SMC）は、

**「逐次的に難しくなる確率分布を、粒子集団で追いかけるアルゴリズム」**

です。

MCMCと比較したときの最大の違いは、以下の2点にあります。

- 単一のサンプルではなく、**粒子集団**を同時に扱う
- 分布が「時間（ステップ）」とともに**徐々に変化**していく

この構造により、SMCでは  
1回の実行で **分布全体とその不確実性** を同時に得ることができます。

---

## SMCを構成する基本要素

SMCは、いくつかの単純な要素の組み合わせで構成されています。

### 粒子（Particles）

粒子とは、パラメータ空間上のサンプルです。  
SMCでは、1つの点ではなく **多数の粒子の集合** を使って分布を表現します。

### 重み（Importance Weights）

各粒子には、その粒子が  
「現在の目標分布にどれだけ適合しているか」を表す重みが割り当てられます。

時間が進むにつれて、この重みは偏っていく傾向があります。

### 再サンプリング（Resampling）

重みが極端に偏ると、多くの粒子が実質的に意味を持たなくなります。  
これを防ぐために、有効な粒子を複製し、  
無効な粒子を捨てる操作が再サンプリングです。

### 変化する目標分布

SMCでは、最初から難しい分布を直接扱いません。

- 最初は「簡単な分布」
- 徐々に「目的とする難しい分布」

へと移動していきます。

この変化は、温度（tempering）やデータ数の増加によって実現されます。

---

## SMCアルゴリズムの基本フロー

SMCの基本的な流れは、以下のように表せます。

Initialize particles from prior

for step = 1, 2, ..., K:
- 重みの更新
- ESSの計算
- 必要なら再サンプリング
- MCMCによる粒子の拡散（mutation）


### 重みはなぜ偏るのか

分布が変化すると、  
一部の粒子だけが新しい分布に適合し、  
それ以外の粒子の重みは急激に小さくなります。

この現象を「粒子退化」と呼びます。

### なぜ再サンプリングが必要なのか

粒子退化が進むと、  
「粒子数は多いが、実質的には数個しか意味を持たない」  
状態になります。

再サンプリングは、この問題を回避するために不可欠な操作です。

---

## Likelihood tempering と Data tempering

SMCでは、「分布を徐々に難しくする」方法として  
主に以下の2つが使われます。

### Likelihood tempering

尤度に指数（温度）をかけ、  
その指数を 0 から 1 に徐々に増やしていく方法です。

### Data tempering

データを少数から徐々に追加していき、  
観測情報を段階的に強くしていく方法です。

どちらも、

**「簡単な分布から難しい分布へ移動する」**

という点で本質的には同じ考え方に基づいています。

具体的な制御方法については、次のページで詳しく説明します。

---

## SMCの出力

SMCを実行することで、以下の情報が得られます。

- パラメータの事後分布
- 推定値の不確実性（分散・信用区間など）
- 正規化定数（Evidence）

これは、点推定だけを行う手法とは大きく異なる利点です。

---

## 本コードで提供するもの

本サイトで扱うSMCコードは、以下を目的として設計されています。

- 汎用的に使えるSMCフレームワーク
- Likelihood tempering / Data tempering の切り替え
- 並列計算を前提とした設計
- 研究用途を意識した再現性の確保

次のページでは、  
これらの挙動を制御する **ハイパーパラメータ** について説明します。
